{{define "admin_settings.html"}}<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings — Firewatch</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
<div class="admin-shell">
{{template "admin_nav" .}}
<main class="admin-content admin-main">

  <div class="settings-topbar">
    <h1>Settings</h1>
    <div class="settings-topbar-actions">
      <span id="save-result" class="settings-feedback"></span>
      <button type="submit" form="settings-form">Save Settings</button>
    </div>
  </div>

  <form id="settings-form">

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>Mail Configuration</h2>
      </div>
      <div class="settings-rows">
        <div class="settings-row">
          <label class="settings-row-label" for="s-destEmail">
            Destination Email
            <span class="settings-row-hint">Where form submissions are delivered</span>
          </label>
          <input type="email" id="s-destEmail" name="destinationEmail" value="{{.DestinationEmail}}">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-subject">
            Email Subject
            <span class="settings-row-hint">Supports {{"{{"}}fieldId{{"}}"}} tokens</span>
          </label>
          <input type="text" id="s-subject" name="emailSubjectTemplate" value="{{.EmailSubjectTemplate}}">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-from">
            From Address
          </label>
          <input type="email" id="s-from" name="smtpFromAddress" value="{{.SMTPFromAddress}}">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-fromname">
            From Name
          </label>
          <input type="text" id="s-fromname" name="smtpFromName" value="{{.SMTPFromName}}">
        </div>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>SMTP Server</h2>
      </div>
      <div class="settings-rows">
        <div class="settings-row">
          <label class="settings-row-label" for="s-host">
            Host
            <span class="settings-row-hint">e.g. smtp.gmail.com</span>
          </label>
          <input type="text" id="s-host" name="smtpHost" value="{{.SMTPHost}}">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-port">
            Port
            <span class="settings-row-hint">e.g. 587 for STARTTLS, 465 for SSL</span>
          </label>
          <input type="number" id="s-port" name="smtpPort" value="{{.SMTPPort}}" class="settings-input-narrow">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-user">
            Username
          </label>
          <input type="text" id="s-user" name="smtpUser" value="{{.SMTPUser}}">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-pass">
            Password
            <span class="settings-row-hint">Leave blank to keep current value</span>
          </label>
          <input type="password" id="s-pass" name="smtpPass" placeholder="••••••••">
        </div>
      </div>
      <div class="settings-card-footer">
        <button type="button" id="btn-test-email">Send Test Email</button>
        <span id="test-email-result" class="settings-feedback"></span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>General</h2>
      </div>
      <div class="settings-rows">
        <div class="settings-row">
          <label class="settings-row-label" for="s-maintenance">
            Maintenance Mode
            <span class="settings-row-hint">Disables the public form and shows a maintenance page</span>
          </label>
          <label class="toggle-switch">
            <input type="checkbox" id="s-maintenance" name="maintenanceMode" {{if .MaintenanceMode}}checked{{end}}>
            <span class="toggle-track"></span>
          </label>
        </div>
      </div>
    </div>

    <div class="settings-bottom-bar">
      <button type="button" id="btn-apply" class="btn-secondary">Re-apply Settings</button>
      <span id="apply-result" class="settings-feedback"></span>
      <button type="submit">Save Settings</button>
    </div>

  </form>
</main>
</div><!-- admin-shell -->
<script>
document.getElementById('settings-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  data.smtpPort = parseInt(data.smtpPort, 10) || 0;
  data.maintenanceMode = !!e.target.querySelector('[name="maintenanceMode"]').checked;
  const r = await fetch('/api/admin/settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
  });
  const el = document.getElementById('save-result');
  el.textContent = r.ok ? 'Saved.' : 'Failed to save.';
  el.className = 'settings-feedback ' + (r.ok ? 'feedback-ok' : 'feedback-err');
  setTimeout(() => { el.textContent = ''; el.className = 'settings-feedback'; }, 3000);
});
document.getElementById('btn-test-email').addEventListener('click', async () => {
  const el = document.getElementById('test-email-result');
  el.textContent = 'Sending…';
  const r = await fetch('/api/admin/settings/test-email', { method: 'POST' });
  el.textContent = r.ok ? 'Sent!' : 'Failed.';
  el.className = 'settings-feedback ' + (r.ok ? 'feedback-ok' : 'feedback-err');
});
document.getElementById('btn-apply').addEventListener('click', async () => {
  const el = document.getElementById('apply-result');
  const r = await fetch('/api/admin/settings/apply', { method: 'POST' });
  el.textContent = r.ok ? 'Applied.' : 'Error.';
  el.className = 'settings-feedback ' + (r.ok ? 'feedback-ok' : 'feedback-err');
});
</script>
</body>
</html>
{{end}}
