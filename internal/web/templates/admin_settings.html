{{define "admin_settings.html"}}<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Settings — Firewatch</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
</head>
<body>
<div class="admin-shell">
{{template "admin_nav" .}}
<main class="admin-content admin-main">

  <div class="settings-topbar">
    <h1>Settings</h1>
    <div class="settings-topbar-actions">
      <span id="save-result" class="settings-feedback"></span>
      <button type="submit" form="settings-form">Save Settings</button>
    </div>
  </div>

  {{if or (not .SMTPVerified) (not .PGPVerified)}}
  <div class="alert alert-warning" id="auto-maintenance-banner">
    <strong>Maintenance mode is active</strong> — the public form is unavailable until the following issues are resolved:
    <ul>
      {{if not .SMTPVerified}}<li><strong>SMTP:</strong> {{if .SMTPError}}{{.SMTPError}}{{else}}not verified{{end}}</li>{{end}}
      {{if not .PGPVerified}}<li><strong>PGP:</strong> {{if .PGPError}}{{.PGPError}}{{else}}not verified{{end}}</li>{{end}}
    </ul>
    Save valid settings below to lift this restriction automatically.
  </div>
  {{end}}

  <form id="settings-form">

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>Mail Configuration</h2>
      </div>
      <div class="settings-rows">
        <div class="settings-row">
          <label class="settings-row-label" for="s-destEmail">
            Destination Email
            <span class="settings-row-hint">Where form submissions are delivered</span>
          </label>
          <input type="email" id="s-destEmail" name="destinationEmail" value="{{.DestinationEmail}}">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-subject">
            Email Subject
            <span class="settings-row-hint">Supports {{"{{"}}fieldId{{"}}"}} tokens</span>
          </label>
          <input type="text" id="s-subject" name="emailSubjectTemplate" value="{{.EmailSubjectTemplate}}">
        </div>
        <div class="settings-row settings-row--top">
          <label class="settings-row-label" for="s-pgp">
            PGP Public Key
            <span class="settings-row-hint">Used to encrypt outgoing report emails</span>
            <span id="pgp-badge" class="status-badge {{if .PGPVerified}}badge-ok{{else}}badge-err{{end}}">
              {{if .PGPVerified}}Verified{{else}}Not verified{{end}}
            </span>
            {{if and (not .PGPVerified) .PGPError}}<span class="settings-row-hint badge-err-text">{{.PGPError}}</span>{{end}}
          </label>
          <textarea id="s-pgp" name="pgpKey" rows="4" placeholder="-----BEGIN PGP PUBLIC KEY BLOCK-----">{{.PGPKey}}</textarea>
          <span id="pgp-key-err" class="badge-err-text" style="display:none">Private key detected — paste the public key only.</span>
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-from">
            From Address
          </label>
          <input type="email" id="s-from" name="smtpFromAddress" value="{{.SMTPFromAddress}}">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-fromname">
            From Name
          </label>
          <input type="text" id="s-fromname" name="smtpFromName" value="{{.SMTPFromName}}">
        </div>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>SMTP Server</h2>
        <span id="smtp-badge" class="status-badge {{if .SMTPVerified}}badge-ok{{else}}badge-err{{end}}">
          {{if .SMTPVerified}}Verified{{else}}Not verified{{end}}
        </span>
        {{if and (not .SMTPVerified) .SMTPError}}<span class="settings-row-hint badge-err-text">{{.SMTPError}}</span>{{end}}
      </div>
      <div class="settings-rows">
        <div class="settings-row">
          <label class="settings-row-label" for="s-host">
            Host
            <span class="settings-row-hint">e.g. smtp.gmail.com</span>
          </label>
          <input type="text" id="s-host" name="smtpHost" value="{{.SMTPHost}}">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-port">
            Port
            <span class="settings-row-hint">e.g. 587 for STARTTLS, 465 for SSL</span>
          </label>
          <input type="number" id="s-port" name="smtpPort" value="{{.SMTPPort}}" class="settings-input-narrow">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-user">
            Username
          </label>
          <input type="text" id="s-user" name="smtpUser" value="{{.SMTPUser}}">
        </div>
        <div class="settings-row">
          <label class="settings-row-label" for="s-pass">
            Password
            <span class="settings-row-hint">
              {{if .SMTPPassSet}}Password configured — leave blank to keep current value{{else}}No password set{{end}}
            </span>
          </label>
          <input type="password" id="s-pass" name="smtpPass" placeholder="••••••••">
        </div>
      </div>
      <div class="settings-card-footer">
        <button type="button" id="btn-test-email">Send Test Email</button>
        <span id="test-email-result" class="settings-feedback"></span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-header">
        <h2>General</h2>
      </div>
      <div class="settings-rows">
        <div class="settings-row">
          <label class="settings-row-label" for="s-maintenance">
            Maintenance Mode
            <span class="settings-row-hint">Manual override. Maintenance mode is also forced on when SMTP or PGP verification fails.</span>
          </label>
          <label class="toggle-switch">
            <input type="checkbox" id="s-maintenance" name="maintenanceMode" {{if .MaintenanceMode}}checked{{end}}>
            <span class="toggle-track"></span>
          </label>
        </div>
      </div>
    </div>

    <div class="settings-bottom-bar">
      <button type="button" id="btn-apply" class="btn-secondary">Re-apply Settings</button>
      <span id="apply-result" class="settings-feedback"></span>
      <button type="submit">Save Settings</button>
    </div>

  </form>
</main>
</div><!-- admin-shell -->
<script>
function isPrivatePGPKey(v) {
  return v.includes('-----BEGIN PGP PRIVATE KEY BLOCK-----') ||
         v.includes('-----BEGIN PGP SECRET KEY BLOCK-----');
}

document.getElementById('s-pgp').addEventListener('input', function() {
  const isPrivate = isPrivatePGPKey(this.value);
  document.getElementById('pgp-key-err').style.display = isPrivate ? '' : 'none';
  document.querySelectorAll('button[type="submit"]').forEach(b => b.disabled = isPrivate);
});

function applyVerification(v) {
  const smtpBadge = document.getElementById('smtp-badge');
  const pgpBadge = document.getElementById('pgp-badge');
  const banner = document.getElementById('auto-maintenance-banner');

  if (smtpBadge) {
    smtpBadge.textContent = v.smtpVerified ? 'Verified' : 'Not verified';
    smtpBadge.className = 'status-badge ' + (v.smtpVerified ? 'badge-ok' : 'badge-err');
  }
  if (pgpBadge) {
    pgpBadge.textContent = v.pgpVerified ? 'Verified' : 'Not verified';
    pgpBadge.className = 'status-badge ' + (v.pgpVerified ? 'badge-ok' : 'badge-err');
  }

  const needsMaintenance = !v.smtpVerified || !v.pgpVerified;
  if (needsMaintenance && !banner) {
    // Reload so the server-rendered banner appears with the correct error text.
    location.reload();
  } else if (!needsMaintenance && banner) {
    banner.remove();
  }
}

document.getElementById('settings-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = Object.fromEntries(new FormData(e.target));
  data.smtpPort = parseInt(data.smtpPort, 10) || 0;
  data.maintenanceMode = !!e.target.querySelector('[name="maintenanceMode"]').checked;
  const r = await fetch('/api/admin/settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
  });
  const el = document.getElementById('save-result');
  if (r.ok) {
    const v = await r.json();
    applyVerification(v);
    el.textContent = 'Saved.';
    el.className = 'settings-feedback feedback-ok';
  } else {
    el.textContent = 'Failed to save.';
    el.className = 'settings-feedback feedback-err';
  }
  setTimeout(() => { el.textContent = ''; el.className = 'settings-feedback'; }, 3000);
});

document.getElementById('btn-test-email').addEventListener('click', async () => {
  const form = document.getElementById('settings-form');
  const data = Object.fromEntries(new FormData(form));
  data.smtpPort = parseInt(data.smtpPort, 10) || 0;
  data.maintenanceMode = !!form.querySelector('[name="maintenanceMode"]').checked;
  const el = document.getElementById('test-email-result');
  el.textContent = 'Sending…';
  const r = await fetch('/api/admin/settings/test-email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
  });
  el.textContent = r.ok ? 'Sent!' : 'Failed.';
  el.className = 'settings-feedback ' + (r.ok ? 'feedback-ok' : 'feedback-err');
});

document.getElementById('btn-apply').addEventListener('click', async () => {
  const el = document.getElementById('apply-result');
  const r = await fetch('/api/admin/settings/apply', { method: 'POST' });
  if (r.ok) {
    const v = await r.json();
    applyVerification(v);
    el.textContent = 'Applied.';
    el.className = 'settings-feedback feedback-ok';
  } else {
    el.textContent = 'Error.';
    el.className = 'settings-feedback feedback-err';
  }
});
</script>
</body>
</html>
{{end}}
