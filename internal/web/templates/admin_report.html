{{define "admin_report.html"}}<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Form Editor — Firewatch</title>
  <link rel="stylesheet" href="/static/style.css">
  <link rel="icon" href="/static/favicon.svg" type="image/svg+xml">
  <script src="/static/sortable.min.js"></script>
  <script src="/static/alpine.min.js" defer></script>
</head>
<body>
<div class="admin-shell" x-data="formEditor({{.SchemaJSON}})" x-init="init()">
{{template "admin_nav" .}}
<div class="admin-content">

<!-- Tab bar + action bar -->
<div class="editor-topbar">
  <div class="tab-bar">
    <button class="tab" :class="{ active: activeTab === 'form' }"
            @click="activeTab = 'form'">Form</button>
    <button class="tab" :class="{ active: activeTab === 'email' }"
            @click="activeTab = 'email'">Email Template</button>
  </div>
  <div class="action-bar">
    <button class="save-indicator" :class="'save-indicator--' + saveStatus"
            @click="manualSave()" :disabled="saveStatus === 'saving'">
      <span class="save-indicator-icon" :class="{ 'save-icon-spin': saveStatus === 'saving' }"
            x-text="{ saved: '✓', unsaved: '●', saving: '↻', error: '✕' }[saveStatus]"></span>
      <span x-text="{ saved: 'Saved', unsaved: 'Unsaved', saving: 'Saving…', error: 'Failed' }[saveStatus]"></span>
    </button>
    <label class="topbar-toggle" x-show="activeTab === 'form'">
      <span>Preview</span>
      <span class="toggle-switch">
        <input type="checkbox" x-model="preview">
        <span class="toggle-track"></span>
      </span>
    </label>
    <button class="btn-danger-outline" @click="revert()">Revert to Published</button>
    <button @click="publish()">Publish Changes</button>
  </div>
</div>

<!-- Form Tab -->
<div x-show="activeTab === 'form'" class="editor-layout" :class="{ 'editor-preview': preview }">
  <!-- Field Palette -->
  <div class="field-palette" id="field-palette" x-show="!preview">
    <div class="field-palette-title">Fields</div>
    <div class="palette-item" data-type="text" @click="addField('text')">
      <span class="palette-item-icon">—</span>Short Text
    </div>
    <div class="palette-item" data-type="textarea" @click="addField('textarea')">
      <span class="palette-item-icon">≡</span>Long Text
    </div>
    <div class="palette-item" data-type="accordion" @click="addField('accordion')">
      <span class="palette-item-icon">▾</span>Accordion
    </div>
  </div>

  <!-- Center Canvas -->
  <div class="canvas-panel">
    <div class="canvas-inner">
      <!-- Page header item -->
      <div class="canvas-section canvas-page-header"
           :class="{ selected: isPageSelected && !preview }"
           @click="!preview && selectItem('__page__')">
        <header class="form-header" style="margin-bottom:0">
          <h1 x-text="schema.page.i18n[editingLang]?.title || schema.page.i18n['en']?.title || ''"></h1>
          <p class="subtitle"
             x-show="schema.page.i18n[editingLang]?.subtitle || schema.page.i18n['en']?.subtitle"
             x-text="schema.page.i18n[editingLang]?.subtitle || schema.page.i18n['en']?.subtitle || ''"></p>
        </header>
      </div>

      <!-- Field items (SortableJS target) -->
      <div id="canvas-fields">
        <template x-for="field in sortedFields" :key="field.id">
          <div class="canvas-section canvas-field"
               :class="{ selected: selectedId === field.id && !preview }"
               :data-field-id="field.id"
               @click="!preview && selectItem(field.id)">
            <div class="drag-handle canvas-drag-handle">&#10303;</div>
            <section class="field-group canvas-field-group">
              <template x-if="field.type !== 'accordion'">
                <div>
                  <h2 class="field-label">
                    <span x-text="field.i18n[editingLang]?.label || field.i18n['en']?.label || ''"></span>
                    <template x-if="field.required"><span class="required"> *</span></template>
                  </h2>
                  <p class="field-desc"
                     x-show="field.i18n[editingLang]?.description || field.i18n['en']?.description"
                     x-text="field.i18n[editingLang]?.description || field.i18n['en']?.description || ''"></p>
                  <input type="text" :disabled="!preview"
                         :placeholder="field.i18n[editingLang]?.placeholder || field.i18n['en']?.placeholder || ''"
                         x-show="field.type === 'text'">
                  <textarea :disabled="!preview"
                            :placeholder="field.i18n[editingLang]?.placeholder || field.i18n['en']?.placeholder || ''"
                            rows="3"
                            x-show="field.type === 'textarea'"></textarea>
                </div>
              </template>
              <template x-if="field.type === 'accordion'">
                <details class="field-group canvas-accordion">
                  <summary x-text="field.i18n[editingLang]?.label || field.i18n['en']?.label || 'Accordion Title'"></summary>
                  <p x-text="field.i18n[editingLang]?.description || field.i18n['en']?.description || 'No content yet.'"></p>
                </details>
              </template>
            </section>
            <button class="canvas-delete-btn"
                    x-show="selectedId === field.id"
                    @click.stop="deleteField(field.id)"
                    title="Delete field">&#10005;</button>
          </div>
        </template>
      </div>

      <button :disabled="!preview"
              x-text="schema.page.i18n[editingLang]?.submitButtonLabel || schema.page.i18n['en']?.submitButtonLabel || 'Submit'"
              class="canvas-submit-btn"></button>

    </div>
  </div>

  <!-- Side Inspector -->
  <div class="inspector-panel" x-show="!preview">
    <!-- Empty state -->
    <div class="inspector-empty" x-show="selectedId === null">
      <p>Select a field or the page header to edit its properties.</p>
    </div>

    <!-- Language tab strip (shown when more than one language is enabled) -->
    <div class="lang-tabs" x-show="schema.languages && schema.languages.length > 1 && selectedId !== null">
      <template x-for="l in enabledLangs" :key="l.Code">
        <button class="lang-tab" :class="{ active: editingLang === l.Code }"
                @click="editingLang = l.Code" x-text="l.Code.toUpperCase()"></button>
      </template>
    </div>

    <!-- Page Settings inspector -->
    <div class="inspector-content" x-show="isPageSelected">
      <h3>Page Settings</h3>
      <div class="inspector-field">
        <label>Title</label>
        <input type="text" x-model="schema.page.i18n[editingLang].title">
      </div>
      <div class="inspector-field">
        <label>Subtitle</label>
        <input type="text" x-model="schema.page.i18n[editingLang].subtitle">
      </div>
      <div class="inspector-field">
        <label>Submit Button Label</label>
        <input type="text" x-model="schema.page.i18n[editingLang].submitButtonLabel">
      </div>

      <!-- Languages enable section -->
      <div class="inspector-field">
        <label>Languages</label>
        <template x-for="l in SUPPORTED_LANGUAGES" :key="l.Code">
          <label class="toggle-label" style="margin-bottom:0.5rem">
            <span x-text="l.Name"></span>
            <template x-if="l.Code !== 'en'">
              <span class="toggle-switch">
                <input type="checkbox"
                       :checked="schema.languages && schema.languages.includes(l.Code)"
                       @change="toggleLanguage(l.Code, $event.target.checked)">
                <span class="toggle-track"></span>
              </span>
            </template>
            <template x-if="l.Code === 'en'">
              <span style="font-size:0.8rem;color:var(--color-muted)">Always on</span>
            </template>
          </label>
        </template>
      </div>
    </div>

    <!-- Field inspector -->
    <template x-if="selectedField !== null">
      <div class="inspector-content">
        <h3 x-text="'Field: ' + (selectedField.i18n[editingLang]?.label || selectedField.i18n['en']?.label || '')"></h3>
        <div class="inspector-field">
          <label>ID</label>
          <input type="text" :value="selectedField.id" @change="selectedField.id = $event.target.value">
        </div>
        <div class="inspector-field">
          <label>Type</label>
          <input type="text" disabled
                 :value="{ text: 'Short Text', textarea: 'Long Text', accordion: 'Accordion' }[selectedField.type]">
        </div>
        <div class="inspector-field">
          <label>Label</label>
          <input type="text" x-model="selectedField.i18n[editingLang].label">
        </div>
        <div class="inspector-field">
          <label x-text="selectedField.type === 'accordion' ? 'Content' : 'Description'"></label>
          <textarea x-model="selectedField.i18n[editingLang].description"
                    :rows="selectedField.type === 'accordion' ? 6 : 3"></textarea>
        </div>
        <div class="inspector-field" x-show="selectedField.type !== 'accordion'">
          <label>Placeholder</label>
          <input type="text" x-model="selectedField.i18n[editingLang].placeholder">
        </div>
        <div class="inspector-field" x-show="selectedField.type !== 'accordion'">
          <label class="toggle-label">
            <span>Required</span>
            <span class="toggle-switch">
              <input type="checkbox" x-model="selectedField.required">
              <span class="toggle-track"></span>
            </span>
          </label>
        </div>
        <div class="inspector-order-btns">
          <button class="order-btn" @click="moveUp()"
                  :disabled="selectedIndex === 0"
                  title="Move up">&#8593; Move up</button>
          <button class="order-btn" @click="moveDown()"
                  :disabled="selectedIndex === sortedFields.length - 1"
                  title="Move down">&#8595; Move down</button>
        </div>
        <div class="inspector-delete-row">
          <button class="delete-btn" @click="deleteField(selectedField.id)">Delete Field</button>
        </div>
      </div>
    </template>
  </div>
</div>

<!-- Email Template Tab -->
<div x-show="activeTab === 'email'" class="editor-layout editor-email">
  <!-- Token Palette -->
  <div class="field-palette">
    <div class="field-palette-title">Insert Field</div>
    <template x-for="field in schema.fields.filter(f => f.type !== 'accordion')" :key="field.id">
      <div class="palette-item palette-item--token" @click="insertToken(field.id)"
           :title="'{' + '{' + field.id + '}' + '}'">
        <span x-text="field.i18n[editingLang]?.label || field.i18n['en']?.label || field.id"></span>
      </div>
    </template>
    <div x-show="schema.fields.filter(f => f.type !== 'accordion').length === 0" class="field-palette-empty">No insertable fields.</div>
  </div>

  <div class="email-editor-panel">
    <div class="email-panel-header">
      <h2>Template</h2>
      <!-- Language tab strip for email -->
      <div class="lang-tabs" x-show="schema.languages && schema.languages.length > 1" style="margin-top:0.5rem;border-bottom:none;padding-bottom:0;margin-bottom:0">
        <template x-for="l in enabledLangs" :key="l.Code">
          <button class="lang-tab" :class="{ active: editingLang === l.Code }"
                  @click="editingLang = l.Code" x-text="l.Code.toUpperCase()"></button>
        </template>
      </div>
    </div>
    <textarea id="email-template" class="email-textarea" x-model="schema.emailTemplates[editingLang]" spellcheck="false"></textarea>
  </div>
  <div class="email-preview-panel">
    <div class="email-panel-header">
      <h2>Preview</h2>
    </div>
    <pre class="email-preview-body" x-text="emailPreview()"></pre>
  </div>
</div>

</div><!-- admin-content -->
</div><!-- admin-shell -->

<script>
const SUPPORTED_LANGUAGES = {{.SupportedLanguagesJSON}};

function formEditor(initialSchema) {
  return {
    schema: initialSchema,
    editingLang: (initialSchema.languages && initialSchema.languages[0]) || 'en',
    selectedId: '__page__',
    saveStatus: 'saved',
    _saveTimer: null,
    activeTab: 'form',
    preview: false,

    // Fields sorted by per-language display order for the current editing language.
    get sortedFields() {
      return [...this.schema.fields].sort((a, b) => {
        const oa = (a.i18n && a.i18n[this.editingLang] && a.i18n[this.editingLang].order) || a.order || 0;
        const ob = (b.i18n && b.i18n[this.editingLang] && b.i18n[this.editingLang].order) || b.order || 0;
        return oa - ob;
      });
    },

    // Enabled languages with names resolved from SUPPORTED_LANGUAGES.
    get enabledLangs() {
      if (!this.schema.languages) return [];
      return SUPPORTED_LANGUAGES.filter(l => this.schema.languages.includes(l.Code));
    },

    get selectedField() {
      if (!this.selectedId || this.selectedId === '__page__') return null;
      return this.schema.fields.find(f => f.id === this.selectedId) ?? null;
    },

    get selectedIndex() {
      return this.sortedFields.findIndex(f => f.id === this.selectedId);
    },

    get isPageSelected() { return this.selectedId === '__page__'; },

    // _seedLang ensures every enabled language has a complete i18n entry on
    // the page meta, emailTemplates, and every field. Safe to call repeatedly.
    // Each missing or empty property is pre-populated from the default language.
    _seedLang(code) {
      const def = this.schema.languages[0] || 'en';

      // Page meta — fill each property individually.
      const defPage = this.schema.page.i18n[def] || {};
      if (!this.schema.page.i18n[code]) this.schema.page.i18n[code] = {};
      const pageLoc = this.schema.page.i18n[code];
      if (!pageLoc.title)             pageLoc.title             = defPage.title             || '';
      if (!pageLoc.subtitle)          pageLoc.subtitle          = defPage.subtitle          || '';
      if (!pageLoc.submitButtonLabel) pageLoc.submitButtonLabel = defPage.submitButtonLabel || '';

      // Email template.
      if (!this.schema.emailTemplates[code]) {
        this.schema.emailTemplates[code] = this.schema.emailTemplates[def] || '';
      }

      // Fields — fill each property individually.
      this.schema.fields.forEach(f => {
        const defLocale = f.i18n[def] || {};
        if (!f.i18n[code]) f.i18n[code] = {};
        const loc = f.i18n[code];
        if (!loc.label)       loc.label       = defLocale.label       || '';
        if (!loc.description) loc.description = defLocale.description || '';
        if (!loc.placeholder) loc.placeholder = defLocale.placeholder || '';
        if (!loc.order)       loc.order       = f.order || 0;
      });
    },

    init() {
      // Ensure top-level containers exist.
      if (!this.schema.languages || !this.schema.languages.length) this.schema.languages = ['en'];
      if (!this.schema.page.i18n) this.schema.page.i18n = {};
      if (!this.schema.emailTemplates) this.schema.emailTemplates = {};
      this.schema.fields.forEach(f => { if (!f.i18n) f.i18n = {}; });

      // Seed every enabled language so inspector bindings never see undefined.
      this.schema.languages.forEach(lang => this._seedLang(lang));

      Sortable.create(document.getElementById('field-palette'), {
        group: { name: 'canvas', pull: 'clone', put: false },
        sort: false,
        animation: 150,
      });

      Sortable.create(document.getElementById('canvas-fields'), {
        group: { name: 'canvas', pull: true, put: true },
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'canvas-drop-ghost',
        onAdd: (evt) => {
          const type = evt.item.dataset.type;
          const idx = evt.newIndex;
          evt.item.remove();
          const f = this._makeField(type);
          const fields = [...this.schema.fields];
          // Assign base order so all language fallbacks work correctly.
          f.order = idx + 1;
          fields.splice(idx, 0, f);
          this.schema.fields = fields.map((field, i) => ({ ...field, order: i + 1 }));
          this.$nextTick(() => this.selectItem(f.id));
        },
        onEnd: () => {
          // Update per-language order based on the new DOM order.
          const ids = [...document.querySelectorAll('#canvas-fields [data-field-id]')]
            .map(el => el.dataset.fieldId);
          ids.forEach((id, idx) => {
            const f = this.schema.fields.find(f => f.id === id);
            if (f) {
              if (!f.i18n[this.editingLang]) {
                f.i18n[this.editingLang] = { label: '', description: '', placeholder: '', order: idx + 1 };
              } else {
                f.i18n[this.editingLang].order = idx + 1;
              }
            }
          });
          this.markDirty();
        },
      });

      this.$watch('schema', () => { this.markDirty(); });
    },

    _makeField(type) {
      const defaults = {
        text:      { label: 'New Text Field', placeholder: 'Enter text…' },
        textarea:  { label: 'New Long Text',  placeholder: 'Enter text…' },
        accordion: { label: 'New Section',    placeholder: ''            },
      };
      const d = defaults[type] || defaults.text;
      const i18n = {};
      const langs = this.schema.languages || ['en'];
      langs.forEach(lang => {
        i18n[lang] = { label: d.label, description: '', placeholder: d.placeholder, order: 0 };
      });
      return { id: 'field_' + Date.now(), required: false, type, order: 0, i18n };
    },

    toggleLanguage(code, enabled) {
      if (code === 'en') return; // English is always on.
      if (enabled) {
        if (!this.schema.languages.includes(code)) {
          this.schema.languages.push(code);
        }
        // Seed all i18n entries for the new language before switching to it.
        this._seedLang(code);
        this.editingLang = code;
      } else {
        this.schema.languages = this.schema.languages.filter(l => l !== code);
        if (this.editingLang === code) {
          this.editingLang = 'en';
        }
      }
    },

    markDirty() {
      this.saveStatus = 'unsaved';
      clearTimeout(this._saveTimer);
      this._saveTimer = setTimeout(() => this.saveDraft(), 1500);
    },

    manualSave() {
      clearTimeout(this._saveTimer);
      this.saveDraft();
    },

    selectItem(id) { this.selectedId = this.selectedId === id ? '__page__' : id; },

    moveUp() {
      const sorted = this.sortedFields;
      const idx = sorted.findIndex(f => f.id === this.selectedId);
      if (idx <= 0) return;
      const curr = sorted[idx];
      const prev = sorted[idx - 1];
      this._seedLang(this.editingLang);
      const currOrder = curr.i18n[this.editingLang].order || curr.order || idx + 1;
      const prevOrder = prev.i18n[this.editingLang].order || prev.order || idx;
      curr.i18n[this.editingLang].order = prevOrder;
      prev.i18n[this.editingLang].order = currOrder;
    },

    moveDown() {
      const sorted = this.sortedFields;
      const idx = sorted.findIndex(f => f.id === this.selectedId);
      if (idx < 0 || idx >= sorted.length - 1) return;
      const curr = sorted[idx];
      const next = sorted[idx + 1];
      this._seedLang(this.editingLang);
      const currOrder = curr.i18n[this.editingLang].order || curr.order || idx + 1;
      const nextOrder = next.i18n[this.editingLang].order || next.order || idx + 2;
      curr.i18n[this.editingLang].order = nextOrder;
      next.i18n[this.editingLang].order = currOrder;
    },

    insertToken(fieldId) {
      const token = '{' + '{' + fieldId + '}' + '}';
      const el = document.getElementById('email-template');
      const start = el.selectionStart;
      const end = el.selectionEnd;
      const tpl = this.schema.emailTemplates[this.editingLang] || '';
      this.schema.emailTemplates[this.editingLang] = tpl.slice(0, start) + token + tpl.slice(end);
      this.$nextTick(() => {
        el.focus();
        el.setSelectionRange(start + token.length, start + token.length);
      });
    },

    emailPreview() {
      const tpl = this.schema.emailTemplates[this.editingLang] || '';
      return this.schema.fields.reduce((t, field) => {
        const locale = (field.i18n && (field.i18n[this.editingLang] || field.i18n['en'])) || {};
        return t.replaceAll('{' + '{' + field.id + '}' + '}', locale.placeholder || locale.label || '');
      }, tpl);
    },

    addField(type) {
      const f = this._makeField(type);
      f.order = this.schema.fields.length + 1;
      this.schema.languages.forEach(lang => {
        if (f.i18n[lang]) f.i18n[lang].order = f.order;
      });
      this.schema.fields.push(f);
      this.$nextTick(() => this.selectItem(f.id));
    },

    deleteField(id) {
      this.schema.fields = this.schema.fields
        .filter(f => f.id !== id)
        .map((f, idx) => ({ ...f, order: idx + 1 }));
      this.selectedId = '__page__';
    },

    async saveDraft() {
      this.saveStatus = 'saving';
      try {
        const res = await fetch('/api/admin/report', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            schemaVersion: this.schema.schemaVersion,
            languages: this.schema.languages,
            page: this.schema.page,
            fields: this.schema.fields,
            emailTemplates: this.schema.emailTemplates,
          }),
        });
        if (!res.ok) throw new Error('save failed');
        if (this.saveStatus === 'saving') this.saveStatus = 'saved';
      } catch {
        this.saveStatus = 'error';
      }
    },

    async publish() {
      if (!confirm('Publish changes to the live form?')) return;
      await fetch('/api/admin/report/apply', { method: 'POST' });
    },

    async revert() {
      if (!confirm('Discard all unpublished changes and revert to the current live version?')) return;
      const r = await fetch('/api/admin/report/revert', { method: 'POST' });
      if (r.ok) {
        window.location.reload();
      }
    },
  };
}
</script>
</body>
</html>
{{end}}
