{{define "admin_report.html"}}<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Report Form Editor — Firewatch</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="/static/sortable.min.js"></script>
  <script src="/static/alpine.min.js" defer></script>
</head>
<body>
<div class="admin-shell" x-data="formEditor({{.SchemaJSON}})" x-init="init()">
{{template "admin_nav" .}}
<div class="admin-content">

<!-- Tab bar + action bar -->
<div class="editor-topbar">
  <div class="tab-bar">
    <button class="tab" :class="{ active: activeTab === 'form' }"
            @click="activeTab = 'form'">Form</button>
    <button class="tab" :class="{ active: activeTab === 'email' }"
            @click="activeTab = 'email'">Email Template</button>
  </div>
  <div class="action-bar">
    <button class="save-indicator" :class="'save-indicator--' + saveStatus"
            @click="manualSave()" :disabled="saveStatus === 'saving'">
      <span class="save-indicator-icon" :class="{ 'save-icon-spin': saveStatus === 'saving' }"
            x-text="{ saved: '✓', unsaved: '●', saving: '↻', error: '✕' }[saveStatus]"></span>
      <span x-text="{ saved: 'Saved', unsaved: 'Unsaved', saving: 'Saving…', error: 'Failed' }[saveStatus]"></span>
    </button>
    <button @click="publish()">Publish Changes</button>
  </div>
</div>

<!-- Form Tab -->
<div x-show="activeTab === 'form'" class="editor-layout">
  <!-- Field Palette -->
  <div class="field-palette" id="field-palette">
    <div class="field-palette-title">Fields</div>
    <div class="palette-item" data-type="text" @click="addField('text')">
      <span class="palette-item-icon">—</span>Short Text
    </div>
    <div class="palette-item" data-type="textarea" @click="addField('textarea')">
      <span class="palette-item-icon">≡</span>Long Text
    </div>
    <div class="palette-item" data-type="accordion" @click="addField('accordion')">
      <span class="palette-item-icon">▾</span>Accordion
    </div>
  </div>

  <!-- Center Canvas -->
  <div class="canvas-panel">
    <div class="canvas-inner">
      <!-- Page header item -->
      <div class="canvas-section canvas-page-header"
           :class="{ selected: isPageSelected }"
           @click="selectItem('__page__')">
        <header class="form-header" style="margin-bottom:0">
          <h1 x-text="schema.page.title"></h1>
          <p class="subtitle" x-show="schema.page.subtitle" x-text="schema.page.subtitle"></p>
        </header>
      </div>

      <!-- Field items (SortableJS target) -->
      <div id="canvas-fields">
        <template x-for="field in schema.fields" :key="field.id">
          <div class="canvas-section canvas-field"
               :class="{ selected: selectedId === field.id }"
               :data-field-id="field.id"
               @click="selectItem(field.id)">
            <div class="drag-handle canvas-drag-handle">&#10303;</div>
            <section class="field-group canvas-field-group">
              <template x-if="field.type !== 'accordion'">
                <div>
                  <h2 class="field-label">
                    <span x-text="field.label"></span><template x-if="field.required"><span class="required"> *</span></template>
                  </h2>
                  <p class="field-desc" x-show="field.description" x-text="field.description"></p>
                  <input type="text" disabled :placeholder="field.placeholder"
                         x-show="field.type === 'text'">
                  <textarea disabled :placeholder="field.placeholder" rows="3"
                            x-show="field.type === 'textarea'"></textarea>
                </div>
              </template>
              <template x-if="field.type === 'accordion'">
                <details class="field-group canvas-accordion">
                  <summary x-text="field.label || 'Accordion Title'"></summary>
                  <p x-text="field.description || 'No content yet.'"></p>
                </details>
              </template>
            </section>
            <button class="canvas-delete-btn"
                    x-show="selectedId === field.id"
                    @click.stop="deleteField(field.id)"
                    title="Delete field">&#10005;</button>
          </div>
        </template>
      </div>

      <button disabled x-text="schema.page.submitButtonLabel"
              class="canvas-submit-btn"></button>

    </div>
  </div>

  <!-- Side Inspector -->
  <div class="inspector-panel">
    <!-- Empty state -->
    <div class="inspector-empty" x-show="selectedId === null">
      <p>Select a field or the page header to edit its properties.</p>
    </div>

    <!-- Page Settings inspector -->
    <div class="inspector-content" x-show="isPageSelected">
      <h3>Page Settings</h3>
      <div class="inspector-field">
        <label>Title</label>
        <input type="text" x-model="schema.page.title">
      </div>
      <div class="inspector-field">
        <label>Subtitle</label>
        <input type="text" x-model="schema.page.subtitle">
      </div>
      <div class="inspector-field">
        <label>Submit Button Label</label>
        <input type="text" x-model="schema.page.submitButtonLabel">
      </div>
    </div>

    <!-- Field inspector -->
    <template x-if="selectedField !== null">
      <div class="inspector-content">
        <h3 x-text="'Field: ' + selectedField.label"></h3>
        <div class="inspector-field">
          <label>ID</label>
          <input type="text" :value="selectedField.id" @change="selectedField.id = $event.target.value">
        </div>
        <div class="inspector-field">
          <label>Label</label>
          <input type="text" x-model="selectedField.label">
        </div>
        <div class="inspector-field">
          <label x-text="selectedField.type === 'accordion' ? 'Content' : 'Description'"></label>
          <textarea x-model="selectedField.description"
                    :rows="selectedField.type === 'accordion' ? 6 : 3"></textarea>
        </div>
        <div class="inspector-field" x-show="selectedField.type !== 'accordion'">
          <label>Placeholder</label>
          <input type="text" x-model="selectedField.placeholder">
        </div>
        <div class="inspector-field" x-show="selectedField.type !== 'accordion'">
          <label class="toggle-label">
            <span>Required</span>
            <span class="toggle-switch">
              <input type="checkbox" x-model="selectedField.required">
              <span class="toggle-track"></span>
            </span>
          </label>
        </div>
        <div class="inspector-order-btns">
          <button class="order-btn" @click="moveUp()"
                  :disabled="selectedIndex === 0"
                  title="Move up">&#8593; Move up</button>
          <button class="order-btn" @click="moveDown()"
                  :disabled="selectedIndex === schema.fields.length - 1"
                  title="Move down">&#8595; Move down</button>
        </div>
        <div class="inspector-delete-row">
          <button class="delete-btn" @click="deleteField(selectedField.id)">Delete Field</button>
        </div>
      </div>
    </template>
  </div>
</div>

<!-- Email Template Tab -->
<div x-show="activeTab === 'email'" class="editor-layout editor-email">
  <!-- Token Palette -->
  <div class="field-palette">
    <div class="field-palette-title">Insert Field</div>
    <template x-for="field in schema.fields" :key="field.id">
      <div class="palette-item palette-item--token" @click="insertToken(field.id)"
           :title="'{' + '{' + field.id + '}' + '}'">
        <span x-text="field.label"></span>
      </div>
    </template>
    <div x-show="schema.fields.length === 0" class="field-palette-empty">No fields defined yet.</div>
  </div>

  <div class="email-editor-panel">
    <div class="email-panel-header">
      <h2>Template</h2>
    </div>
    <textarea id="email-template" class="email-textarea" x-model="schema.emailTemplate" spellcheck="false"></textarea>
  </div>
  <div class="email-preview-panel">
    <div class="email-panel-header">
      <h2>Preview</h2>
    </div>
    <pre class="email-preview-body" x-text="emailPreview()"></pre>
  </div>
</div>

</div><!-- admin-content -->
</div><!-- admin-shell -->

<script>
function formEditor(initialSchema) {
  return {
    schema: initialSchema,
    selectedId: '__page__',
    saveStatus: 'saved',
    _saveTimer: null,
    activeTab: 'form',

    get selectedField() {
      if (!this.selectedId || this.selectedId === '__page__') return null;
      return this.schema.fields.find(f => f.id === this.selectedId) ?? null;
    },

    get selectedIndex() {
      return this.schema.fields.findIndex(f => f.id === this.selectedId);
    },

    get isPageSelected() { return this.selectedId === '__page__'; },

    init() {
      Sortable.create(document.getElementById('field-palette'), {
        group: { name: 'canvas', pull: 'clone', put: false },
        sort: false,
        animation: 150,
      });

      Sortable.create(document.getElementById('canvas-fields'), {
        group: { name: 'canvas', pull: true, put: true },
        handle: '.drag-handle',
        animation: 150,
        ghostClass: 'canvas-drop-ghost',
        onAdd: (evt) => {
          const type = evt.item.dataset.type;
          const idx = evt.newIndex;
          evt.item.remove();
          const f = this._makeField(type);
          const fields = [...this.schema.fields];
          fields.splice(idx, 0, f);
          this.schema.fields = fields.map((field, i) => ({ ...field, order: i + 1 }));
          this.$nextTick(() => this.selectItem(f.id));
        },
        onEnd: () => {
          const ids = [...document.querySelectorAll('#canvas-fields [data-field-id]')]
            .map(el => el.dataset.fieldId);
          this.schema.fields = ids.map((id, i) => ({
            ...this.schema.fields.find(f => f.id === id),
            order: i + 1,
          }));
        },
      });

      this.$watch('schema', () => { this.markDirty(); });
    },

    _makeField(type) {
      const defaults = {
        text:      { label: 'New Text Field', placeholder: 'Enter text…' },
        textarea:  { label: 'New Long Text',  placeholder: 'Enter text…' },
        accordion: { label: 'New Section',    placeholder: ''            },
      };
      const d = defaults[type] || defaults.text;
      return { id: 'field_' + Date.now(), label: d.label, description: '', placeholder: d.placeholder, required: false, type, order: 0 };
    },

    markDirty() {
      this.saveStatus = 'unsaved';
      clearTimeout(this._saveTimer);
      this._saveTimer = setTimeout(() => this.saveDraft(), 1500);
    },

    manualSave() {
      clearTimeout(this._saveTimer);
      this.saveDraft();
    },

    selectItem(id) { this.selectedId = this.selectedId === id ? '__page__' : id; },

    moveUp() {
      const i = this.selectedIndex;
      if (i <= 0) return;
      const fields = [...this.schema.fields];
      [fields[i - 1], fields[i]] = [fields[i], fields[i - 1]];
      this.schema.fields = fields.map((f, idx) => ({ ...f, order: idx + 1 }));
    },

    insertToken(fieldId) {
      const token = '{' + '{' + fieldId + '}' + '}';
      const el = document.getElementById('email-template');
      const start = el.selectionStart;
      const end = el.selectionEnd;
      this.schema.emailTemplate =
        this.schema.emailTemplate.slice(0, start) + token + this.schema.emailTemplate.slice(end);
      this.$nextTick(() => {
        el.focus();
        el.setSelectionRange(start + token.length, start + token.length);
      });
    },

    emailPreview() {
      return this.schema.fields.reduce((tpl, field) => {
        return tpl.replaceAll('{' + '{' + field.id + '}' + '}', field.placeholder || field.label);
      }, this.schema.emailTemplate);
    },

    addField(type) {
      const f = this._makeField(type);
      f.order = this.schema.fields.length + 1;
      this.schema.fields.push(f);
      this.$nextTick(() => this.selectItem(f.id));
    },

    moveDown() {
      const i = this.selectedIndex;
      if (i < 0 || i >= this.schema.fields.length - 1) return;
      const fields = [...this.schema.fields];
      [fields[i], fields[i + 1]] = [fields[i + 1], fields[i]];
      this.schema.fields = fields.map((f, idx) => ({ ...f, order: idx + 1 }));
    },

    deleteField(id) {
      this.schema.fields = this.schema.fields
        .filter(f => f.id !== id)
        .map((f, idx) => ({ ...f, order: idx + 1 }));
      this.selectedId = '__page__';
    },

    async saveDraft() {
      this.saveStatus = 'saving';
      try {
        const res = await fetch('/api/admin/report', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            page: this.schema.page,
            fields: this.schema.fields,
            emailTemplate: this.schema.emailTemplate,
          }),
        });
        if (!res.ok) throw new Error('save failed');
        if (this.saveStatus === 'saving') this.saveStatus = 'saved';
      } catch {
        this.saveStatus = 'error';
      }
    },

    async publish() {
      if (!confirm('Publish changes to the live form?')) return;
      await fetch('/api/admin/report/apply', { method: 'POST' });
    },
  };
}
</script>
</body>
</html>
{{end}}
